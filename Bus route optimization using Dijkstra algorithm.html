<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Route Optimization System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: #4CAF50;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .route-form {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .map-container {
            height: 400px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        
        #passenger-map, #driver-map {
            height: 100%;
            width: 100%;
        }
        
        .alerts {
            padding: 15px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .dashboard-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel-item {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .panel-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .panel-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .transport-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .transport-option {
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: calc(33.33% - 10px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .transport-option h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .transport-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .rating {
            display: flex;
            gap: 5px;
            margin-top: 15px;
        }
        
        .rating span {
            cursor: pointer;
            font-size: 20px;
            color: #ddd;
        }
        
        .rating span.active {
            color: #FFD700;
        }
        
        .saved-routes {
            margin-top: 20px;
        }
        
        .route-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .route-details {
            flex: 1;
        }
        
        .route-actions {
            display: flex;
            gap: 10px;
        }
        
        .speed-monitor {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .speed-gauge {
            width: 150px;
            height: 150px;
            position: relative;
            border-radius: 50%;
            background: linear-gradient(90deg, green, yellow, red);
            overflow: hidden;
        }
        
        .speed-indicator {
            position: absolute;
            width: 130px;
            height: 130px;
            top: 10px;
            left: 10px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .speed-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .speed-unit {
            font-size: 12px;
            color: #777;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .transport-option {
                width: 100%;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group button {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; margin-bottom: 20px;">Bus Route Optimization System</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="passenger">Passenger Dashboard</div>
            <div class="tab" data-tab="driver">Driver Dashboard</div>
        </div>
        
        <!-- Passenger Dashboard -->
        <div class="tab-content active" id="passenger-dashboard">
            <div class="route-form">
                <h2>Plan Your Journey</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="passenger-source">Source</label>
                        <input type="text" id="passenger-source" placeholder="Enter your starting point">
                    </div>
                    <div class="form-group">
                        <label for="passenger-destination">Destination</label>
                        <input type="text" id="passenger-destination" placeholder="Enter your destination">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="passenger-time">Departure Time</label>
                        <input type="time" id="passenger-time">
                    </div>
                    <div class="form-group">
                        <label for="passenger-date">Date</label>
                        <input type="date" id="passenger-date">
                    </div>
                </div>
                <button onclick="findRoute('passenger')">Find Route</button>
                <button onclick="saveRoute()">Save Route</button>
            </div>
            
            <div class="alerts" id="passenger-alerts">
                Traffic alert: Heavy traffic detected on your route. Alternative route suggested.
            </div>
            
            <div class="map-container">
                <div id="passenger-map"></div>
            </div>
            
            <h3>Nearby Transport Options</h3>
            <div class="transport-options" id="nearby-transport">
                <!-- Transport options will be dynamically populated -->
            </div>
            
            <h3>Rate Your Last Journey</h3>
            <div class="rating">
                <span>★</span>
                <span>★</span>
                <span>★</span>
                <span>★</span>
                <span>★</span>
            </div>
            <div class="form-group" style="margin-top: 10px;">
                <textarea placeholder="Share your feedback" style="width: 100%; padding: 10px; height: 100px;"></textarea>
            </div>
            <button>Submit Feedback</button>
            
            <div class="saved-routes">
                <h3>Saved Routes</h3>
                <div class="route-item">
                    <div class="route-details">
                        <strong>Bengaluru to Mysuru</strong>
                        <div>Bengaluru to Mysuru</div>
                    </div>
                    <div class="route-actions">
                        <button onclick="useRoute('Bengaluru', 'Mysuru')">Use This Route</button>
                        <button style="background-color: #dc3545;" onclick="deleteRoute('Bengaluru', 'Mysuru')">Delete</button>
                    </div>
                </div>
                <div class="route-item">
                    <div class="route-details">
                        <strong>Delhi to Jaipur</strong>
                        <div>Delhi to Jaipur</div>
                    </div>
                    <div class="route-actions">
                        <button onclick="useRoute('Delhi', 'Jaipur')">Use This Route</button>
                        <button style="background-color: #dc3545;" onclick="deleteRoute('Delhi', 'Jaipur')">Delete</button>
                    </div>
                </div>
                <div id="dynamic-routes"></div>
            </div>
        </div>
        
        <!-- Driver Dashboard -->
        <div class="tab-content" id="driver-dashboard">
            <div class="dashboard-panel">
                <div class="panel-item">
                    <div class="panel-title">Current Speed</div>
                    <div class="panel-value">45 km/h</div>
                </div>
                <div class="panel-item">
                    <div class="panel-title">Distance Covered</div>
                    <div class="panel-value">12.5 km</div>
                </div>
                <div class="panel-item">
                    <div class="panel-title">Passengers</div>
                    <div class="panel-value">23</div>
                </div>
                <div class="panel-item">
                    <div class="panel-title">ETA</div>
                    <div class="panel-value">35 min</div>
                </div>
            </div>
            
            <div class="speed-monitor">
                <div class="speed-gauge">
                    <div class="speed-indicator">
                        <div class="speed-value">45</div>
                        <div class="speed-unit">km/h</div>
                    </div>
                </div>
                <div>
                    <h3>Speed Monitor</h3>
                    <p>Current status: Normal</p>
                    <p>Speed limit on this road: 60 km/h</p>
                </div>
            </div>
            
            <div class="alerts" id="driver-alerts">
                <strong>EMERGENCY ALERT:</strong> Heavy traffic ahead due to accident. Consider taking the next right turn to avoid delay.
            </div>
            
            <div class="route-form">
                <h2>Set Route</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="driver-source">Source</label>
                        <input type="text" id="driver-source" placeholder="Enter starting point">
                    </div>
                    <div class="form-group">
                        <label for="driver-destination">Destination</label>
                        <input type="text" id="driver-destination" placeholder="Enter destination">
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="findRoute('driver')">Start Navigation</button>
                    <button onclick="showRoute()">Show Route</button>
                    <button style="background-color: #ff9800;">Report Emergency</button>
                </div>
            </div>
            
            <div class="map-container">
                <div id="driver-map"></div>
            </div>
            
            <h3>Upcoming Stops</h3>
            <div style="margin-top: 10px;">
                <div class="route-item">
                    <div class="route-details">
                        <strong>Majestic Bus Stand</strong>
                        <div>ETA: 5 min</div>
                    </div>
                    <div>8 passengers waiting</div>
                </div>
                <div class="route-item">
                    <div class="route-details">
                        <strong>Shivajinagar</strong>
                        <div>ETA: 15 min</div>
                    </div>
                    <div>12 passengers waiting</div>
                </div>
                <div class="route-item">
                    <div class="route-details">
                        <strong>Hebbal</strong>
                        <div>ETA: 30 min</div>
                    </div>
                    <div>5 passengers waiting</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet.js for maps (no API key required) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine for directions -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
    
    <script>
        // Global variables for maps and directions
        let passengerMap, driverMap;
        let passengerRoutingControl, driverRoutingControl;

        // Comprehensive list of valid Indian states, union territories, and cities
        const validIndianLocations = [
            // States
            'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa', 'Gujarat',
            'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka', 'Kerala', 'Madhya Pradesh',
            'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab',
            'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura', 'Uttar Pradesh',
            'Uttarakhand', 'West Bengal',
            // Union Territories
            'Andaman and Nicobar Islands', 'Chandigarh', 'Dadra and Nagar Haveli and Daman and Diu',
            'Delhi', 'Jammu and Kashmir', 'Ladakh', 'Lakshadweep', 'Puducherry',
            // Major Cities
            'Amaravati', 'Itanagar', 'Dispur', 'Patna', 'Raipur', 'Panaji', 'Gandhinagar', 'Chandigarh',
            'Shimla', 'Ranchi', 'Bengaluru', 'Bangalore', 'Thiruvananthapuram', 'Bhopal', 'Mumbai',
            'Imphal', 'Shillong', 'Aizawl', 'Kohima', 'Bhubaneswar', 'Jaipur', 'Gangtok', 'Chennai',
            'Hyderabad', 'Agartala', 'Lucknow', 'Dehradun', 'Kolkata', 'Port Blair', 'New Delhi',
            'Daman', 'Srinagar', 'Jammu', 'Leh', 'Kavaratti', 'Puducherry', 'Pondicherry',
            'Surat', 'Kanpur', 'Nagpur', 'Indore', 'Thane', 'Visakhapatnam', 'Pimpri-Chinchwad',
            'Vadodara', 'Ghaziabad', 'Ludhiana', 'Agra', 'Nashik', 'Faridabad', 'Meerut', 'Rajkot',
            'Kalyan-Dombivli', 'Vasai-Virar', 'Varanasi', 'Aurangabad', 'Dhanbad', 'Amritsar',
            'Navi Mumbai', 'Allahabad', 'Prayagraj', 'Howrah', 'Gwalior', 'Jabalpur', 'Coimbatore',
            'Vijayawada', 'Jodhpur', 'Madurai', 'Kota', 'Guwahati', 'Solapur', 'Hubli-Dharwad',
            'Mysuru', 'Mysore', 'Tiruchirappalli', 'Bareilly', 'Aligarh', 'Tiruppur', 'Moradabad',
            'Jalandhar', 'Salem', 'Warangal', 'Mira-Bhayandar', 'Jalgaon', 'Guntur', 'Bhiwandi',
            'Saharanpur', 'Gorakhpur', 'Bikaner', 'Amravati', 'Noida', 'Jamshedpur', 'Bhilai',
            'Cuttack', 'Firozabad', 'Kochi', 'Nellore', 'Bhavnagar', 'Durgapur', 'Asansol',
            'Rourkela', 'Nanded', 'Kolhapur', 'Ajmer', 'Akola', 'Gulbarga', 'Jamnagar', 'Ujjain',
            'Loni', 'Siliguri', 'Jhansi', 'Ulhasnagar', 'Sangli-Miraj & Kupwad', 'Mangaluru',
            'Mangalore', 'Erode', 'Belagavi', 'Ambattur', 'Tirunelveli', 'Malegaon', 'Gaya',
            'Udaipur', 'Davanagere', 'Kozhikode', 'Kurnool', 'Rajahmundry', 'Bokaro Steel City',
            'South Dumdum', 'Bellary', 'Patiala', 'Gopalpur', 'Agartala', 'Bhagalpur', 'Muzaffarnagar',
            'Bhatpara', 'Panihati', 'Latur', 'Dhule', 'Rohtak', 'Korba', 'Bhilwara', 'Brahmapur',
            'Muzaffarpur', 'Kakinada', 'Hisar', 'Chandrapur', 'Baranagar', 'Naihati', 'Kirari Suleman Nagar',
            'Purnia', 'Satna', 'Mau', 'Sonipat', 'Farrukhabad', 'Sagar', 'Durg', 'Imphal', 'Ratlam',
            'Hapur', 'Arrah', 'Anantapur', 'Karimnagar', 'Etawah', 'Ambernath', 'North Dumdum',
            'Bharatpur', 'Begusarai', 'Gandhidham', 'Barasat', 'Tiruvottiyur', 'Sikar',
            'Thoothukudi', 'Rewa', 'Mirzapur', 'Raichur', 'Pali', 'Ramagundam', 'Haridwar',
            'Vijayanagaram', 'Katihar', 'Nagarcoil', 'Sri Ganganagar', 'Karawal Nagar', 'Mango',
            'Thanjavur', 'Bulandshahr', 'Uluberia', 'Katni', 'Sambhal', 'Singrauli', 'Nadiad',
            'Secunderabad', 'Yamunanagar', 'Bidhannagar', 'Pallavaram', 'Bidar', 'Munger',
            'Panchkula', 'Burhanpur', 'Ranaghat', 'Kharagpur', 'Dindigul', 'Hospet',
            'Nangloi Jat', 'Malda', 'Ongole', 'Deoghar', 'Chapra', 'Haldia', 'Khandwa', 'Nandyal',
            'Morena', 'Amroha', 'Anand', 'Bhind', 'Bhalswa Jahangir Pur', 'Madhyamgram', 'Bhiwani',
            'Berhampore', 'Ambala', 'Morvi', 'Fatehpur', 'Raebareli', 'Khora', 'Bhusawal', 'Orai',
            'Bahraich', 'Vellore', 'Mehsana', 'Raiganj', 'Sirsa', 'Danapur', 'Serampore',
            'Sultan Pur Majra', 'Gonda', 'Guntakal', 'Jaunpur', 'Panvel', 'Shivpuri',
            'Surendranagar Dudhrej', 'Unnao', 'Tinsukia', 'Itarsi', 'Kohima', 'Balangir', 'Nawada',
            'Jharsuguda', 'Jagtial', 'Viluppuram', 'Amalner', 'Zirakpur', 'Tanda', 'Tiruchengode',
            'Nagina', 'Yemmiganur', 'Vaniyambadi', 'Sarni', 'Theni Allinagaram', 'Margao', 'Akot',
            'Sehore', 'Mhow Cantonment', 'Kot Kapura', 'Makrana', 'Pandharpur', 'Miryalaguda',
            'Shamli', 'Seoni', 'Ranibennur', 'Kadiri', 'Shrirampur'
        ];

        // Transport options database
        const transportOptionsDB = {
            'Delhi': [
                {type: 'Metro', distance: '0.3 km', nextArrival: '4 min', fare: '₹20-40'},
                {type: 'Auto Rickshaw', distance: '0.1 km', estimatedFare: '₹40-60'},
                {type: 'DTC Bus', distance: '0.4 km', nextArrival: '8 min', fare: '₹10'}
            ],
            'Mumbai': [
                {type: 'Local Train', distance: '0.5 km', nextArrival: '7 min', fare: '₹15-30'},
                {type: 'BEST Bus', distance: '0.2 km', nextArrival: '10 min', fare: '₹12'},
                {type: 'Auto Rickshaw', distance: '0.3 km', estimatedFare: '₹35-55'}
            ],
            'Bangalore': [
                {type: 'BMTC Bus', distance: '0.3 km', nextArrival: '12 min', fare: '₹15'},
                {type: 'Metro', distance: '0.6 km', nextArrival: '8 min', fare: '₹20-35'},
                {type: 'Auto Rickshaw', distance: '0.2 km', estimatedFare: '₹50-70'}
            ],
            'Chennai': [
                {type: 'MTC Bus', distance: '0.4 km', nextArrival: '15 min', fare: '₹13'},
                {type: 'Metro Rail', distance: '0.7 km', nextArrival: '10 min', fare: '₹20-40'},
                {type: 'Auto Rickshaw', distance: '0.2 km', estimatedFare: '₹45-65'}
            ],
            'Kolkata': [
                {type: 'Metro', distance: '0.5 km', nextArrival: '6 min', fare: '₹10-25'},
                {type: 'Tram', distance: '0.3 km', nextArrival: '15 min', fare: '₹7'},
                {type: 'Auto Rickshaw', distance: '0.2 km', estimatedFare: '₹30-50'}
            ],
            'Hyderabad': [
                {type: 'Metro', distance: '0.6 km', nextArrival: '9 min', fare: '₹20-45'},
                {type: 'TSRTC Bus', distance: '0.3 km', nextArrival: '14 min', fare: '₹15'},
                {type: 'Auto Rickshaw', distance: '0.2 km', estimatedFare: '₹40-60'}
            ],
            'Pune': [
                {type: 'PMT Bus', distance: '0.4 km', nextArrival: '18 min', fare: '₹12'},
                {type: 'Metro', distance: '0.8 km', nextArrival: '12 min', fare: '₹15-30'},
                {type: 'Auto Rickshaw', distance: '0.2 km', estimatedFare: '₹35-55'}
            ],
            'Ahmedabad': [
                {type: 'AMTS Bus', distance: '0.5 km', nextArrival: '10 min', fare: '₹12'},
                {type: 'BRTS', distance: '0.7 km', nextArrival: '8 min', fare: '₹15-25'},
                {type: 'Auto Rickshaw', distance: '0.3 km', estimatedFare: '₹30-50'}
            ],
            'Jaipur': [
                {type: 'JCTSL Bus', distance: '0.5 km', nextArrival: '16 min', fare: '₹12'},
                {type: 'Metro', distance: '0.9 km', nextArrival: '14 min', fare: '₹15-30'},
                {type: 'Auto Rickshaw', distance: '0.2 km', estimatedFare: '₹35-55'}
            ],
            'Mysore': [
                {type: 'KSRTC City Bus', distance: '0.4 km', nextArrival: '15 min', fare: '₹14'},
                {type: 'Electric Bus', distance: '0.6 km', nextArrival: '20 min', fare: '₹16'},
                {type: 'Auto Rickshaw', distance: '0.2 km', estimatedFare: '₹30-50'}
            ]
        };

        // Default transport options message
        const noTransportOptionsMessage = '<p>No specific transport options available for this destination. Please check local services.</p>';

        // Initialize maps when page loads
        window.onload = function() {
            initMaps();
            loadSavedRoutes();
        };

        // Initialize Leaflet Maps
        function initMaps() {
            const indiaCenter = [20.5937, 78.9629];
            passengerMap = L.map('passenger-map').setView(indiaCenter, 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(passengerMap);
            passengerMap.invalidateSize();

            driverMap = L.map('driver-map').setView(indiaCenter, 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(driverMap);
            driverMap.invalidateSize();

            setTimeout(() => {
                document.getElementById('passenger-source').value = 'Bengaluru';
                document.getElementById('passenger-destination').value = 'Mysuru';
                document.getElementById('driver-source').value = 'Bengaluru';
                document.getElementById('driver-destination').value = 'Mysuru';
                updateTransportOptions('Mysuru');
                findRoute('passenger'); // Auto-display default route
            }, 1000);
        }

        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tabId}-dashboard`).classList.add('active');
                if (tabId === 'passenger') {
                    passengerMap.invalidateSize();
                } else if (tabId === 'driver') {
                    driverMap.invalidateSize();
                }
            });
        });

        // Rating functionality
        const stars = document.querySelectorAll('.rating span');
        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                stars.forEach((s, i) => {
                    if (i <= index) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
            });
        });

        // Function to validate if a location is a valid Indian state or city
        function isValidIndianLocation(location) {
            if (!location) return false;
            const normalizedLocation = location.trim().toLowerCase();
            return validIndianLocations.some(validLocation =>
                validLocation.toLowerCase() === normalizedLocation ||
                normalizedLocation.includes(validLocation.toLowerCase())
            );
        }

        // Function to validate coordinates are within India
        function isWithinIndia(lat, lon) {
            return lat >= 8 && lat <= 37 && lon >= 68 && lon <= 97;
        }

        // Modified route finding functionality
        function findRoute(userType) {
            const sourceId = `${userType}-source`;
            const destId = `${userType}-destination`;
            const source = document.getElementById(sourceId).value.trim();
            const destination = document.getElementById(destId).value.trim();

            // Validate inputs
            if (!source || !destination) {
                alert('Please enter both source and destination');
                return;
            }

            if (!isValidIndianLocation(source) || !isValidIndianLocation(destination)) {
                alert('No routes available: Please enter valid Indian states or cities');
                clearRoute(userType);
                return;
            }

            // Proceed with geocoding
            getGeoCoordinates(source, sourceCoords => {
                if (!sourceCoords) return;
                getGeoCoordinates(destination, destCoords => {
                    if (!destCoords) return;
                    const map = userType === 'passenger' ? passengerMap : driverMap;
                    if (userType === 'passenger' && passengerRoutingControl) {
                        map.removeControl(passengerRoutingControl);
                    } else if (userType === 'driver' && driverRoutingControl) {
                        map.removeControl(driverRoutingControl);
                    }

                    const routingControl = L.Routing.control({
                        waypoints: [
                            L.latLng(sourceCoords[0], sourceCoords[1]),
                            L.latLng(destCoords[0], destCoords[1])
                        ],
                        routeWhileDragging: true,
                        lineOptions: {
                            styles: [{color: '#4CAF50', opacity: 0.7, weight: 6}]
                        },
                        createMarker: function(i, waypoint, n) {
                            return L.marker(waypoint.latLng);
                        }
                    }).addTo(map);

                    if (userType === 'passenger') {
                        passengerRoutingControl = routingControl;
                        updateTransportOptions(destination);
                    } else {
                        driverRoutingControl = routingControl;
                    }

                    setTimeout(() => {
                        document.getElementById(`${userType}-alerts`).style.display = 'block';
                    }, 2000);
                });
            });
        }

        // Function to clear route and UI elements
        function clearRoute(userType) {
            const map = userType === 'passenger' ? passengerMap : driverMap;
            if (userType === 'passenger' && passengerRoutingControl) {
                map.removeControl(passengerRoutingControl);
                passengerRoutingControl = null;
                const transportContainer = document.getElementById('nearby-transport');
                transportContainer.innerHTML = noTransportOptionsMessage;
            } else if (userType === 'driver' && driverRoutingControl) {
                map.removeControl(driverRoutingControl);
                driverRoutingControl = null;
            }
            document.getElementById(`${userType}-alerts`).style.display = 'none';
        }

        // Function to find geocoordinates using Nominatim API with retry
        function getGeoCoordinates(location, callback, retryCount = 2) {
            const nominatimUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)},India&format=json&limit=1`;
            fetch(nominatimUrl)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        if (isWithinIndia(lat, lon)) {
                            callback([lat, lon]);
                        } else {
                            alert(`Location not found in India: ${location}`);
                            callback(null);
                        }
                    } else if (retryCount > 0) {
                        setTimeout(() => getGeoCoordinates(location, callback, retryCount - 1), 1000);
                    } else {
                        alert(`Location not found in India: ${location}`);
                        callback(null);
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    if (retryCount > 0) {
                        setTimeout(() => getGeoCoordinates(location, callback, retryCount - 1), 1000);
                    } else {
                        alert('Error finding location. Please try again.');
                        callback(null);
                    }
                });
        }

        // Update transport options based on destination
        function updateTransportOptions(destination) {
            const transportContainer = document.getElementById('nearby-transport');
            transportContainer.innerHTML = '';
            const cityNames = Object.keys(transportOptionsDB);
            const mainCity = cityNames.find(city => destination.toLowerCase().includes(city.toLowerCase()));
            if (mainCity) {
                const options = transportOptionsDB[mainCity];
                options.forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'transport-option';
                    let optionHTML = `<h4>${option.type}</h4>`;
                    optionHTML += `<div class="transport-details"><span>Distance:</span><span>${option.distance}</span></div>`;
                    if (option.nextArrival) {
                        optionHTML += `<div class="transport-details"><span>Next arrival:</span><span>${option.nextArrival}</span></div>`;
                    }
                    if (option.fare) {
                        optionHTML += `<div class="transport-details"><span>Fare:</span><span>${option.fare}</span></div>`;
                    }
                    if (option.estimatedFare) {
                        optionHTML += `<div class="transport-details"><span>Estimated fare:</span><span>${option.estimatedFare}</span></div>`;
                    }
                    optionDiv.innerHTML = optionHTML;
                    transportContainer.appendChild(optionDiv);
                });
            } else {
                transportContainer.innerHTML = noTransportOptionsMessage;
            }
        }

        // Show route functionality
        function showRoute() {
            findRoute('driver');
        }

        // Use saved route functionality
        function useRoute(source, destination) {
            document.getElementById('passenger-source').value = source;
            document.getElementById('passenger-destination').value = destination;
            findRoute('passenger');
        }

        // Save route functionality
        function saveRoute() {
            const source = document.getElementById('passenger-source').value.trim();
            const destination = document.getElementById('passenger-destination').value.trim();
            if (!source || !destination) {
                alert('Please enter both source and destination');
                return;
            }
            if (!isValidIndianLocation(source) || !isValidIndianLocation(destination)) {
                alert('Cannot save route: Please enter valid Indian states or cities');
                return;
            }
            const route = { source, destination, name: `${source} to ${destination}` };
            let savedRoutes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');
            savedRoutes.push(route);
            localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));
            appendRouteToUI(route);
            alert(`Route from ${source} to ${destination} saved!`);
        }

        // Load saved routes from localStorage
        function loadSavedRoutes() {
            const savedRoutes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');
            savedRoutes.forEach(route => appendRouteToUI(route));
        }

        // Append route to UI
        function appendRouteToUI(route) {
            const dynamicRoutes = document.getElementById('dynamic-routes');
            const routeItem = document.createElement('div');
            routeItem.className = 'route-item';
            routeItem.innerHTML = `
                <div class="route-details">
                    <strong>${route.name}</strong>
                    <div>${route.source} to ${route.destination}</div>
                </div>
                <div class="route-actions">
                    <button onclick="useRoute('${route.source}', '${route.destination}')">Use This Route</button>
                    <button style="background-color: #dc3545;" onclick="deleteRoute('${route.source}', '${route.destination}')">Delete</button>
                </div>
            `;
            dynamicRoutes.appendChild(routeItem);
        }

        // Delete route
        function deleteRoute(source, destination) {
            let savedRoutes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');
            savedRoutes = savedRoutes.filter(route => 
                !(route.source === source && route.destination === destination)
            );
            localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));
            const dynamicRoutes = document.getElementById('dynamic-routes');
            dynamicRoutes.innerHTML = '';
            loadSavedRoutes();
            alert(`Route from ${source} to ${destination} deleted!`);
        }

        // Simulate speed updates for driver
        function updateSpeed() {
            const speeds = [42, 45, 48, 50, 38, 40, 43];
            const randomSpeed = speeds[Math.floor(Math.random() * speeds.length)];
            document.querySelector('.speed-value').textContent = randomSpeed;
            document.querySelector('.panel-value').textContent = `${randomSpeed} km/h`;
            setTimeout(updateSpeed, 3000);
        }

        updateSpeed();
    </script>
</body>
</html>